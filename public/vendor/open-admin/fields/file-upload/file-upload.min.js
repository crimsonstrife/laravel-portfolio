class FileUpload{constructor(element,options){this.fileTypes={image:/\.(gif|png|jpeg|jpg|svg|webp|bpm|tiff)$/i,html:/\.(htm|html)$/i,word:/\.(doc|docx|rtf)$/i,excel:/\.(xls|xlsx|csv)$/i,powerpoint:/\.(ppt|pptx|pps|potx)$/i,text:/\.(txt|rtf|md|csv|nfo|ini|json|php|js|css|ts|sql)$/i,video:/\.(og?|mp4|m4p|m4v|webm|mp?g|mov|3gp|avi|wmv|mkv)$/i,audio:/\.(og?|mp3|mp?g|wav|flac)$/i,pdf:/\.(pdf)$/i,archive:/\.(zip|rar|7z|gz)$/i},this.fileTypesIcons={image:"icon-file-image",html:"icon-file-code",word:"icon-file-word",excel:"icon-file-excel",powerpoint:"icon-file-powerpoint",text:"icon-file-alt",video:"icon-file-video",audio:"icon-file-audio",pdf:"icon-file-pdf",archive:"icon-file-archive"};var ref=this;void 0===options&&(options={});this.options=Object.assign({},{retainable:!1,sortable:!0,download:!0,delete:!0,confirm_delete:!0},options),this.input=element,this.fieldName=this.input.getAttribute("name").replace("[]",""),this.multiple=element.multiple,this.hasCard=!1,this.index=0;let holder=document.createElement("div");holder.classList.add("file-upload-preview-div"),holder.classList.add("form-field-helper"),holder.classList.add("d-none");let existing_files=document.createElement("div");existing_files.classList.add("files"),existing_files.classList.add("existing"),holder.appendChild(existing_files);let new_files=document.createElement("div");return new_files.classList.add("files"),new_files.classList.add("new"),holder.appendChild(new_files),this.input.parentNode.classList.contains("input-group")?this.input.parentNode.parentNode.insertBefore(holder,this.input.parentNode):this.input.parentNode.insertBefore(holder,this.input),this.input.holder=holder,this.holder=holder,this.new_files=new_files,this.existing_files=existing_files,element.addEventListener("change",(function(event){Array.from(event.target.files).forEach((file=>{let img,fileInfo=ref.getFileInfoFromName("new/"+file.name);fileInfo.uploading=!0,ref.hasCard&&!ref.multiple||(img=ref.createCard(fileInfo)),"image"==fileInfo.type&&(ref.hasCard&&!ref.multiple&&(img=ref.holder.querySelector(".preview")),img.src=URL.createObjectURL(file),img.onload=function(){URL.revokeObjectURL(img.src)})}))})),this.initPreview(this),this.options.sortable&&this.enableSortable(),this}getFileInfoFromName=function(filepath){let icon="none",type="unknown",name=this.getFileFromPath(filepath);for(const[key,value]of Object.entries(this.fileTypes)){new RegExp(value).test(name)&&(type=key,icon=this.fileTypesIcons[key])}return{icon:icon,type:type,filepath:filepath,name:name,size:0,uploading:!1}};getFileFromPath=function(path){return path.split("\\").pop().split("/").pop()};addDeleteField=function(){let deleteFieldName=this.fieldName+"_file_del_";if(!document.getElementById(deleteFieldName)){let deleteField=document.createElement("INPUT");deleteField.setAttribute("type","hidden"),deleteField.setAttribute("id",deleteFieldName),deleteField.setAttribute("name",deleteFieldName),deleteField.setAttribute("autocomplete",!1),this.input.insertAdjacentElement("afterend",deleteField),this.deleteField=deleteField}};addAddField=function(){let addFieldName=this.fieldName+"_file_add_";if(!document.getElementById(addFieldName)){let addField=document.createElement("INPUT");addField.setAttribute("type","hidden"),addField.setAttribute("id",addFieldName),addField.setAttribute("name",addFieldName),addField.setAttribute("autocomplete",!1),this.input.insertAdjacentElement("afterend",addField),this.addField=addField}};addOrderField=function(){let orderFieldName=this.fieldName+"_file_sort_";if(!document.getElementById(orderFieldName)){let orderField=document.createElement("INPUT");orderField.setAttribute("type","hidden"),orderField.setAttribute("id",orderFieldName),orderField.setAttribute("name",orderFieldName),orderField.setAttribute("autocomplete",!1),this.input.insertAdjacentElement("afterend",orderField),this.orderField=orderField}};createCard=function(fileInfo,str){void 0===str&&(str="");let id=this.fieldName+"-"+this.index,cardstr='\n            <div>\n                <div class="card">\n                    <div class="card-image">'+this.preview(fileInfo,id,str)+"\n                        <span class='label'>"+fileInfo.name+'</span>\n                    </div>\n                    <div class="card-body">'+this.optionButtons(fileInfo)+'\n                    </div>\n                </div>\n                <div class="modal fade modal-dialog-centered" id="model-'+id+'" tabindex="-1" aria-hidden="true" style="display:none;">\n                    <div class="modal-dialog">\n                        <div class="modal-content">\n                        <div class="modal-header">\n                            <h5 class="modal-title" id="staticBackdropLabel">'+str+'</h5>\n                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n                        </div>\n                        <div class="modal-body" style="position:relative;">\n                            <img id="model-img-'+id+'" src="'+str+'" style="width:100%;">\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n            ',cardHolder=this.htmlToElement(cardstr),card=cardHolder.querySelector(".card"),modal=cardHolder.querySelector(".modal"),preview=card.querySelector(".preview");if(card.dataset.name=fileInfo.name,card.dataset.filepath=fileInfo.filepath,this.options.delete){let removeBtn=card.querySelector(".icon-trash");removeBtn.ref=this,removeBtn.addEventListener("click",(function(event){event.currentTarget.ref.removeFile(event.currentTarget),event.preventDefault()}))}if(this.options.download){let downloadBtn=card.querySelector(".icon-download");downloadBtn.href=str,downloadBtn.target="_blank",downloadBtn.download=str}return fileInfo.uploading?this.new_files.appendChild(card):this.existing_files.appendChild(card),this.holder.appendChild(modal),this.holder.classList.remove("d-none"),this.hasCard=!0,this.index++,preview};preview=function(fileInfo,id,str){return"image"==fileInfo.type?'<img id="img-'+id+'" class="preview" src="'+str+'" data-bs-toggle="modal" data-bs-target="#model-'+id+'"></img>':'<span id="img-'+id+"\" class='preview icon "+fileInfo.icon+"'></span>"};optionButtons=function(fileInfo){var str="";return this.options.delete&&(str+='<a class="btn btn-light icon-trash"></a> '),this.options.download&&(str+='<a class="btn btn-light icon-download"></a> '),this.options.sortable&&this.multiple&&(fileInfo.uploading?str+='<a class="btn btn-light icon-arrows-alt in-active" title="Can be sorted after save."></a>':str+='<a class="btn btn-light handle icon-arrows-alt"></a>'),str};removeFile=function(btn){var current_obj=this;this.options.retainable||0==this.options.confirm_delete?this.removeFileDo(btn):Swal.fire({title:__("delete_file_on_save"),type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:__("confirm"),showLoaderOnConfirm:!0,cancelButtonText:__("cancel")}).then((function(res){res.isConfirmed&&current_obj.removeFileDo(btn)})).catch((function(res){console.log(res)}))};removeFileDo=function(btn){this.addDeleteField();let card=btn.closest(".card");this.deleteField.value+=card.dataset.filepath+",",card.remove(),this.checkNumCards()};checkNumCards=function(){this.holder.querySelectorAll(".card").length||(this.holder.classList.add("d-none"),this.hasCard=!1)};initPreview=function(ref){if(void 0!==ref.input.dataset.files){new String(ref.input.dataset.files).split(",").forEach((file=>{let fileInfo=this.getFileInfoFromName(file);ref.createCard(fileInfo,this.options.storageUrl+file)}))}};addFileFromUrl=function(url){this.addAddField();var file=url.replace(this.options.storageUrl,"");if(this.multiple){let sep=""!=this.addField.value?",":"";this.addField.value+=sep+file}else this.existing_files.innerHTML="",this.addField.value=file;url=new URL(url);let fileInfo=this.getFileInfoFromName(file);this.createCard(fileInfo,url)};enableSortable=function(){let ref=this;new Sortable(this.existing_files,{animation:150,handle:".handle",onUpdate:function(){ref.setOrder()}})};setOrder=function(evt){this.addOrderField();var arr=[];this.holder.querySelectorAll(".card").forEach((card=>{arr.push(card.dataset.filepath)})),this.orderField.value=arr.join(",")};htmlToElement=function(html){var template=document.createElement("template");return html=html.trim(),template.innerHTML=html,template.content.firstChild};htmlToElements=function(html){var template=document.createElement("template");return template.innerHTML=html,template.content.childNodes}}